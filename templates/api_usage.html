{% extends "base.html" %}
{% block title %}API Usage{% endblock %}

{% block head %}
  {{ super() }}
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
{% endblock %}

{% block content %}
  <div class="container px-3 px-sm-4 mt-5">
    {% include 'admin_menu.html' %}
    <h1 class="mb-4">API Usage Log</h1>
    <div class="container mt-5">
      <h2 class="mb-3">API Cost Over Time</h2>
      <canvas id="costChart" height="50"></canvas>
    </div>
    <div class="container mt-5">
      <h2 class="mb-3">Token Usage by Show</h2>
      <canvas id="tokenBarChart" height="80"></canvas>
    </div>
    <div class="container mt-5">
      <h2 class="mb-3">Query Types</h2>
      <canvas id="queryTypeChart" height="60"></canvas>
    </div>
    <div class="row mb-3">
      <div class="col-md-3">
        <label for="startDate" class="form-label">Start Date</label>
        <input type="date" id="startDate" class="form-control">
      </div>
      <div class="col-md-3">
        <label for="endDate" class="form-label">End Date</label>
        <input type="date" id="endDate" class="form-control">
      </div>
    </div>
    <table id="apiUsageTable" class="table table-striped table-bordered align-middle">
      <thead>
        <tr>
          <th>Character</th>
          <th>Show</th>
          <th>Prompt Tokens</th>
          <th>Completion Tokens</th>
          <th>Total Tokens</th>
          <th>Cost (USD)</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody>
        {% for character, show, prompt, completion, total, cost, timestamp in usage_records %}
        <tr>
          <td>{{ character }}</td>
          <td>{{ show }}</td>
          <td>{{ prompt }}</td>
          <td>{{ completion }}</td>
          <td>{{ total }}</td>
          <td>${{ '%.4f' | format(cost) }}</td>
          <td>{{ timestamp }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="4" class="text-end">Total</th>
          <th id="totalTokensCell"></th>
          <th id="totalCostCell"></th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <!-- jQuery + DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    $(document).ready(function () {
      const table = $('#apiUsageTable').DataTable();
      $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();
        const date = new Date(data[6]); // Assuming timestamp is in column 6
      
        if (
          (!startDate || new Date(startDate) <= date) &&
          (!endDate || new Date(endDate) >= date)
        ) {
          return true;
        }
        return false;
      });
      
      $('#startDate, #endDate').on('change', function () {
        $('#apiUsageTable').DataTable().draw();
      });

      let totalCost = 0;
      let totalTokens = 0;

      table.column(4, { search: 'applied' }).data().each(function (value) {
        const tokens = parseInt(value.replace(/[^0-9]/g, ""));
        if (!isNaN(tokens)) totalTokens += tokens;
      });

      table.column(5, { search: 'applied' }).data().each(function (value) {
        const cost = parseFloat(value.replace(/[^0-9.-]+/g,""));
        if (!isNaN(cost)) totalCost += cost;
      });

      $('#totalTokensCell').text(totalTokens.toLocaleString());
      $('#totalCostCell').text(`$${totalCost.toFixed(4)}`);
    });

    document.addEventListener("DOMContentLoaded", function () {
      const table = $('#apiUsageTable').DataTable();

      // Extract dates and costs from column 6 and 5
      const dateToCost = {};

      table.rows({ search: 'applied' }).every(function () {
        const data = this.data();
        const date = new Date(data[6]).toISOString().slice(0, 10); // YYYY-MM-DD
        const cost = parseFloat(data[5].replace(/[^0-9.-]+/g, ""));
        if (!isNaN(cost)) {
          if (!dateToCost[date]) {
            dateToCost[date] = 0;
          }
          dateToCost[date] += cost;
        }
      });

      const labels = Object.keys(dateToCost).sort();
      const values = labels.map(label => dateToCost[label].toFixed(4));

      const ctx = document.getElementById("costChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Cost (USD)",
            data: values,
            fill: true,
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            borderColor: "rgba(75, 192, 192, 1)",
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: { mode: "index", intersect: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      const showTokenMap = {};

      table.rows({ search: 'applied' }).every(function () {
        const data = this.data();
        let show = data[1].trim().toLowerCase();
        show = show.replace(/\b\w/g, char => char.toUpperCase()); // Title case
        const tokens = parseInt(data[4].replace(/[^0-9]/g, ""));
        if (!isNaN(tokens)) {
          if (!showTokenMap[show]) {
            showTokenMap[show] = 0;
          }
          showTokenMap[show] += tokens;
        }
      });

      const showLabels = Object.keys(showTokenMap);
      const showTokenCounts = showLabels.map(label => showTokenMap[label]);

      const ctx2 = document.getElementById("tokenBarChart").getContext("2d");
      new Chart(ctx2, {
        type: "bar",
        data: {
          labels: showLabels,
          datasets: [{
            label: "Total Tokens",
            data: showTokenCounts,
            backgroundColor: "rgba(153, 102, 255, 0.6)",
            borderColor: "rgba(153, 102, 255, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { mode: "index", intersect: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Tokens'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Show'
              }
            }
          }
        }
      });
    });
    const queryTypeCounts = {};
    
    table.rows({ search: 'applied' }).every(function () {
      const data = this.data();
      const character = data[0].toLowerCase();
      const type = character.includes("chat") ? "Chat" : "Summary";  // Basic heuristic
      if (!queryTypeCounts[type]) {
        queryTypeCounts[type] = 0;
      }
      queryTypeCounts[type]++;
    });
    
    const typeLabels = Object.keys(queryTypeCounts);
    const typeValues = typeLabels.map(label => queryTypeCounts[label]);
    
    const ctx3 = document.getElementById("queryTypeChart").getContext("2d");
    new Chart(ctx3, {
      type: "doughnut",
      data: {
        labels: typeLabels,
        datasets: [{
          label: "Query Type",
          data: typeValues,
          backgroundColor: ["#36A2EB", "#FFCE56", "#FF6384"]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          tooltip: { mode: "index", intersect: false }
        }
      }
    });
  </script>
{% endblock %}